#!/usr/bin/env python
import sys
import getopt

from stat_dashboard_pipeline import Pipeline


class StatPipeline():
    def __init__(self, **kwargs):
        self.pipeline = Pipeline()
        self.time_window = kwargs.get('time_window', 1)

    def run(self):
        if self.time_window:
            self.pipeline.time_window = self.time_window
        self.pipeline.run()

    def migrate(self):
        self.pipeline.migrate()


def main():
    """

    Run:
    stat_pipeline

    Command Line options:
    --migrate / -m
        Run a full migration of historical data to temporary
        CSV files for uploading to Socrata via UI

    """
    unix_options = ":mt"
    gnu_options = ["migrate", "time"]
    cmd_args = sys.argv
    arguments = cmd_args[1:]

    try:
        args, vals = getopt.getopt(arguments, unix_options, gnu_options)
    except getopt.error as err:
        # Return to term with an error code
        print(str(err))
        sys.exit(2)

    stat_pipeline = StatPipeline()
    
    for arg in args:
        if arg[0] in ("-m", "--migrate"):
            stat_pipeline.migrate()
            return

        if arg[0] in ("-t", "--time"):
            stat_pipeline.time_window = vals[0]
            
    # Standard run
    stat_pipeline.run()
    return


if __name__ == '__main__':
    sys.exit(main())
